name: Deploy to VPS

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd ~/app

            # Tag current state for rollback
            DEPLOY_TAG="pre-deploy-$(date +%s)"
            git tag "$DEPLOY_TAG"
            echo "Created rollback tag: $DEPLOY_TAG"

            # Pull latest
            git pull origin main

            # Install deps
            pnpm install --frozen-lockfile

            # Build shared package first
            pnpm --filter shared build

            # Build CMS (sequential, not backgrounded)
            cd apps/cms
            mkdir -p dist/styles
            cp src/styles/custom.css dist/styles/ 2>/dev/null || true
            npx tsc
            npx payload build
            cd ~/app

            # Build web
            pnpm --filter web build

            # Only restart if all builds succeeded
            pm2 restart cms
            pm2 restart web

            echo "Deploy complete: $(date)"
            echo "Rollback tag: $DEPLOY_TAG"
